---
title: "Untitled"
output: html_document
date: "2025-10-20"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r libraries, message=FALSE}
library(tidyverse)
library(readxl)
library(knitr)
library(gridExtra)
library(kableExtra)
library(ggpmisc)
library(ggtext)
```

```{r cars}

read_data <- function(root_directory) {

  # Read the files
  squares    <- read_csv(paste0(root_directory, '/', 'Squares.csv'), show_col_types = FALSE)
  recordings <- read_csv(paste0(root_directory, '/', 'Recordings.csv'), show_col_types = FALSE)

  # Remove spaces from column names
  names(squares)    <- str_replace_all(names(squares), c(" " = "_" ))
  names(recordings) <- str_replace_all(names(recordings), c(" " = "_" ))

  # Multiply density and diffusion coefficient such that units are correct. 
  # Density is evts/µm2/ms and diffusion coefficient is in nm2/ms (or µm2/s)
  # <!--squares$Density <- squares$Density * 1000
  # -->squares$Median_Diffusion_Coefficient <- squares$Median_Diffusion_Coefficient * 1000

  # Only consider recordings:
  #   that have been processed because the process flag was  set
  #   that did not contain too many spot
  #   that have expected lengths (2000 frames)

  recordings <- recordings %>%
    filter(Process_Flag == 'TRUE',
           Number_of_Tracks != -1,
           Number_of_Frames == 2000)

  # Only leave data in Squares and Tracks that corresponds with what is in Recordings
  squares <- squares %>%
    filter(Recording_Name %in% recordings$Recording_Name)

  # Create Valency and Structure in squares master. This only works for Regular probes
  # if (!('Valency' %in% names(squares))) {
  # 
  #   # Suppressing both messages and warnings within the code block
  #   squares <- suppressMessages(suppressWarnings (
  #     squares %>%
  #       separate(Probe_Name, into = c('Valency', 'Structure'), sep = ' ', remove = FALSE) %>%
  #       mutate(
  #         Structure = replace_na(Structure, 'Not specified'),
  #         Valency = if_else(Structure == "Not specified", "Not specified", Valency)
  #       )
  #   ))
  # }

  # Set Structure to Control when Probe is Control
  # squares$Structure[squares$Probe_Name == 'Control'] <- 'Control'

  # Remove the '-' from CHO-MR, because that name is used later as a column name (and that give sproblems)
  recordings$Cell_Type[recordings$Cell_Type == 'CHO-MR']  <- 'CHOMR'

  # fix the MR -/- notation for bmdc and bmdm
  recordings$Cell_Type[recordings$Cell_Type == 'BMDM MR -/-']  <- 'BMDMMRko'
  recordings$Cell_Type[recordings$Cell_Type == 'MR -/-']       <- 'BMDCMRko'

  # Change Adjuvant name from No to None
  recordings$Adjuvant[recordings$Adjuvant %in% c('No', '', NA)] <- 'None'

  # Change adjuvant from None to M0 only for BMDM
  recordings$Adjuvant[recordings$Adjuvant == 'None' & recordings$Cell_Type == 'BMDM'] <- 'M0'

  # Correct concentrations (irrelevant accuracy)
  recordings$Concentration[recordings$Concentration == 4.9] <- 5
  recordings$Concentration[recordings$Concentration == 14.6] <- 15

  # Remove suspect Concentration (question is whether we really used it)
  recordings <- recordings %>%
    filter(recordings$Concentration != 0.1)

  # Make Concentration integer
  # squares$Concentration <- as.numeric(squares$Concentration)

  # Make columns factor where necessary
  probe_factor = c('1 Mono', '2 Mono', '6 Mono', '1 Bi', '2 Bi', '6 Bi', '1 Tri', '2 Tri', '6 Tri', 'Control')
  probe_type_factor = c('Simple', 'Epitope')
  cell_type_factor = c('BMDC', 'CHOMR', 'BMDCMRko', 'iCD103', 'spDC', 'BMDM', 'BMDMMRko', 'CHO')
  adjuvant_factor = c('CytD', 'None', 'LPS', 'LPS+CytD', 'MPLA', 'M1', 'M2', 'M0', 'M1 + SI', 'M2pep')
  valency_factor = c('1', '2', '6', 'Control')
  structure_factor = c('Mono', 'Bi', 'Tri', 'Control')

  # Make columns factor where necessary
  recordings$Probe_Name <- factor(recordings$Probe_Name,  levels = probe_factor)
  recordings$Probe_Type <- factor(recordings$Probe_Type,  levels = probe_type_factor)
  recordings$Cell_Type  <- factor(recordings$Cell_Type,   levels = cell_type_factor)
  recordings$Adjuvant   <- factor(recordings$Adjuvant,    levels = adjuvant_factor)

  # Ensure Median Filtering is Boolean
  # recordings$Median_Filtering <- as.logical(recordings$Median_Filtering)

  write_csv(squares, '~/Downloads/squares_processed.csv')

  return (list(squares=squares, recordings=recordings))
}

```


```{r , echo=FALSE}

root_directory <- '/Users/hans/Paint Test Project'
data <- read_data(root_directory)
squares <- data$squares
recordings <- data$recordings


```
